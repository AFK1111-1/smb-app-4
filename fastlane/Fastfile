# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tool

default_platform(:android)

platform :android do
  desc "Build Android debug APK for development"
  lane :dev_build do
    gradle(task: "clean assembleRelease", project_dir: "./android", properties: {
      "android.injected.signing.store.file" => "#{Dir.pwd}/../credentials/android/release.keystore",
      "android.injected.signing.store.password" => ENV['ANDROID_KEYSTORE_PASSWORD'],
      "android.injected.signing.key.alias" => ENV['ANDROID_KEY_ALIAS'],
      "android.injected.signing.key.password" => ENV['ANDROID_KEY_PASSWORD']
    })
  end

  desc "Submit a new internal test build to play store"
  lane :qa_release do
    previous_build_number = google_play_track_version_codes(
      track: "internal",
      json_key: "credentials/android/google-play-service-key.json"
    )[0]

    increment_version_name(
      gradle_file_path: "android/app/build.gradle"
    )
    increment_version_code(
      gradle_file_path: "android/app/build.gradle",
      version_code: previous_build_number + 1
    )

    gradle(task: "clean bundleRelease", project_dir: "./android", properties: {
      "android.injected.signing.store.file" => "#{Dir.pwd}/../credentials/android/release.keystore",
      "android.injected.signing.store.password" => ENV['ANDROID_KEYSTORE_PASSWORD'],
      "android.injected.signing.key.alias" => ENV['ANDROID_KEY_ALIAS'],
      "android.injected.signing.key.password" => ENV['ANDROID_KEY_PASSWORD']
    })

    upload_to_play_store(
      track: 'internal',
      json_key: "credentials/android/google-play-service-key.json",
      aab: "android/app/build/outputs/bundle/release/app-release.aab"
    )

    changelog_from_git_commits
  end

  desc "Submit a new staging build to play store"
  lane :stg_release do
    increment_version_name(
      gradle_file_path: "android/app/build.gradle"
    )
    increment_version_code(
      gradle_file_path: "android/app/build.gradle"
    )

    gradle(task: "clean bundleRelease", project_dir: "./android", properties: {
      "android.injected.signing.store.file" => "#{Dir.pwd}/../credentials/android/release.keystore",
      "android.injected.signing.store.password" => ENV['ANDROID_KEYSTORE_PASSWORD'],
      "android.injected.signing.key.alias" => ENV['ANDROID_KEY_ALIAS'],
      "android.injected.signing.key.password" => ENV['ANDROID_KEY_PASSWORD']
    })

    upload_to_play_store(
      track: 'closed',
      json_key: "credentials/android/google-play-service-key.json",
      aab: "android/app/build/outputs/bundle/release/app-release.aab"
    )

    changelog_from_git_commits
  end

  desc "Submit a new production build to play store"
  lane :production_release do
    increment_version_name(
      gradle_file_path: "android/app/build.gradle"
    )
    increment_version_code(
      gradle_file_path: "android/app/build.gradle"
    )

    gradle(task: "clean bundleRelease", project_dir: "./android", properties: {
      "android.injected.signing.store.file" => "#{Dir.pwd}/../credentials/android/release.keystore",
      "android.injected.signing.store.password" => ENV['ANDROID_KEYSTORE_PASSWORD'],
      "android.injected.signing.key.alias" => ENV['ANDROID_KEY_ALIAS'],
      "android.injected.signing.key.password" => ENV['ANDROID_KEY_PASSWORD']
    })

    upload_to_play_store(
      track: 'production',
      release_status: "draft",
      json_key: "credentials/android/google-play-service-key.json",
      aab: "android/app/build/outputs/bundle/release/app-release.aab"
    )
  end
end

platform :ios do

  desc "Build iOS simulator app for development"
  lane :dev_build do
    build_ios_app(
      workspace: "ios/smbmobile.xcworkspace",
      scheme: "smbmobile",
      sdk: "iphonesimulator",
      configuration: "Debug",
      derived_data_path: "ios/build",
      output_directory: "ios/build",
      output_name: "smbmobile.app"
    )
  end

  desc "Submit a new QA build to TestFlight"
  lane :qa_release do
    # Debug: Log environment variables and file
    UI.important "=== Fastlane Environment Debug ==="
    UI.message "APP_STORE_CONNECT_API_KEY_ID: #{ENV['APP_STORE_CONNECT_API_KEY_ID'] ? 'âœ… SET' : 'âŒ NOT SET'}"
    UI.message "APP_STORE_CONNECT_ISSUER_ID: #{ENV['APP_STORE_CONNECT_ISSUER_ID'] ? 'âœ… SET' : 'âŒ NOT SET'}"
    UI.message "MATCH_PASSWORD: #{ENV['MATCH_PASSWORD'] ? 'âœ… SET' : 'âŒ NOT SET'}"
    if ENV['MATCH_PASSWORD']
      UI.message "MATCH_PASSWORD length: #{ENV['MATCH_PASSWORD'].length} characters"
      UI.message "MATCH_PASSWORD value: '#{ENV['MATCH_PASSWORD']}'"
    end
    
    key_path = "credentials/ios/AuthKey.p8"
    UI.message "Key file path: #{key_path}"
    
    if File.exist?(key_path)
      file_size = File.size(key_path)
      UI.message "Key file exists: âœ… YES (#{file_size} bytes)"
      
      # Check for null bytes
      content = File.read(key_path)
      if content.include?("\x00")
        UI.error "âŒ ERROR: File contains null bytes!"
        UI.error "First 100 chars: #{content[0..100].inspect}"
      else
        UI.success "âœ… No null bytes detected"
        UI.message "File starts with: #{content[0..50]}"
      end
    else
      UI.error "Key file exists: âŒ NO"
    end
    UI.important "==================================="

    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
      key_filepath: "#{Dir.pwd}/../credentials/ios/AuthKey.p8"
    )

    match(
      type: "appstore",
      readonly: false,
      app_identifier: "com.insighture.smbmobile",
      git_url: "git@github.com:insighture/smb-mobile-fastlane.git",
      api_key: api_key,
      force_for_new_devices: true,
      keychain_password: ENV['KEYCHAIN_PASSWORD'],
      keychain_name: ENV['KEYCHAIN_NAME']
    )
    
    # Update Xcode project with team ID and provisioning profile
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "ios/smbmobile.xcodeproj",
      team_id: "96W7U4JYV4",
      profile_name: "match AppStore com.insighture.smbmobile",
      code_sign_identity: "iPhone Distribution",
      targets: ["smbmobile"]
    )

    # âœ… Fix for versioning
    increment_version_number(
      xcodeproj: "ios/smbmobile.xcodeproj",
      bump_type: "patch"
    )
    increment_build_number(
      xcodeproj: "ios/smbmobile.xcodeproj"
    )

    # Build directly targeting the project/target (bypasses scheme destination validation)
    archive_path = "#{Dir.pwd}/../ios/build/smbmobile.xcarchive"
    build_dir = "#{Dir.pwd}/../ios/build"
    
    UI.message "ðŸ”¨ Building iOS app for arm64 (direct target build, no scheme)..."
    
    UI.important "âš ï¸  This build may encounter asset catalog issues on GitHub Actions with Xcode 16"
    UI.message "The iOS simulator runtime is not properly configured, which may cause asset compilation warnings."
    UI.message "However, if the main app binary builds successfully, we'll proceed with packaging."
    UI.message ""
    
    # Try to build - may fail on asset catalog but succeed on actual compilation
    begin
      sh("cd #{Dir.pwd}/.. && " \
         "xcodebuild build " \
         "-project ./ios/smbmobile.xcodeproj " \
         "-target smbmobile " \
         "-configuration Release " \
         "-sdk iphoneos " \
         "-arch arm64 " \
         "CODE_SIGN_IDENTITY='iPhone Distribution' " \
         "PROVISIONING_PROFILE_SPECIFIER='match AppStore com.insighture.smbmobile' " \
         "DEVELOPMENT_TEAM='96W7U4JYV4' " \
         "TARGETED_DEVICE_FAMILY='1,2' " \
         "ONLY_ACTIVE_ARCH=NO " \
         "ENABLE_BITCODE=NO " \
         "COMPILER_INDEX_STORE_ENABLE=NO " \
         "BUILD_DIR='#{build_dir}' " \
         "CONFIGURATION_BUILD_DIR='#{build_dir}/Release-iphoneos' " \
         "-allowProvisioningUpdates")
      
      UI.success "âœ… Build completed successfully!"
    rescue => ex
      # Build failed - check if app binary was still produced
      UI.important "âš ï¸  Build command failed with error:"
      UI.error ex.message
      UI.important ""
      UI.important "Checking if app binary was still produced despite the error..."
      UI.important "Looking for: #{build_dir}/Release-iphoneos/smbmobile.app/smbmobile"
      
      # List what we have in the build directory
      if Dir.exist?("#{build_dir}/Release-iphoneos")
        UI.message "Contents of Release-iphoneos directory:"
        Dir.entries("#{build_dir}/Release-iphoneos").each { |entry| UI.message "  - #{entry}" }
      else
        UI.error "Release-iphoneos directory doesn't exist"
      end
      
      if File.exist?("#{build_dir}/Release-iphoneos/smbmobile.app/smbmobile")
        UI.success "âœ… App binary exists despite build errors - proceeding!"
      else
        UI.error "âŒ Build failed and no app binary was produced"
        UI.error "This is likely due to the asset catalog compilation requiring iOS simulator runtime"
        UI.error "which is not available on GitHub Actions with Xcode 16."
        UI.error ""
        UI.error "Recommended solutions:"
        UI.error "1. Use Expo EAS Build (cloud build service)"
        UI.error "2. Use a different CI provider (Bitrise, CircleCI)"  
        UI.error "3. Use a self-hosted macOS runner with properly configured Xcode"
        raise ex
      end
    end
    
    UI.success "âœ… Build completed successfully"
    UI.message "ðŸ“¦ Creating archive structure from build output..."
    
    # Create archive structure manually
    sh("mkdir -p '#{archive_path}/Products/Applications'")
    sh("cp -R '#{build_dir}/Release-iphoneos/smbmobile.app' '#{archive_path}/Products/Applications/'")
    
    # Create dSYMs directory if dSYM exists
    if File.exist?("#{build_dir}/Release-iphoneos/smbmobile.app.dSYM")
      sh("mkdir -p '#{archive_path}/dSYMs'")
      sh("cp -R '#{build_dir}/Release-iphoneos/smbmobile.app.dSYM' '#{archive_path}/dSYMs/'")
    end
    
    # Create Info.plist for archive
    info_plist = {
      "ApplicationProperties" => {
        "ApplicationPath" => "Applications/smbmobile.app",
        "CFBundleIdentifier" => "com.insighture.smbmobile",
        "SigningIdentity" => "iPhone Distribution: Insighture PTY LTD (96W7U4JYV4)",
        "TeamID" => "96W7U4JYV4"
      },
      "ArchiveVersion" => 2,
      "Name" => "smbmobile",
      "SchemeName" => "smbmobile"
    }
    
    require 'plist'
    File.write("#{archive_path}/Info.plist", Plist::Emit.dump(info_plist))
    
    UI.success "âœ… Archive created at: #{archive_path}"
    
    # Use gym only for exporting the IPA (skip the build phase)
    build_ios_app(
      skip_build_archive: true,
      archive_path: archive_path,
      export_method: "app-store",
      output_directory: "./ios/build",
      export_options: {
        method: "app-store",
        provisioningProfiles: {
          "com.insighture.smbmobile" => "match AppStore com.insighture.smbmobile"
        },
        teamID: "96W7U4JYV4"
      },
      output_name: "smbmobile.ipa"
    )

    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )

    changelog_from_git_commits
  end

  desc "Submit a new staging build to TestFlight"
  lane :stg_release do
    increment_version_number(
      xcodeproj: "ios/smbmobile.xcodeproj",
      bump_type: "patch"
    )
    increment_build_number(
      xcodeproj: "ios/smbmobile.xcodeproj"
    )

    build_ios_app(
      workspace: "ios/smbmobile.xcworkspace",
      scheme: "smbmobile",
      export_method: "app-store",
      export_options: {
        method: "app-store",
        provisioningProfiles: {
          "com.insighture.smbmobile" => "match AppStore com.insighture.smbmobile"
        }
      },
      output_directory: "ios/build",
      output_name: "smbmobile.ipa",
      team_id: ENV['APPLE_TEAM_ID'] || "96W7U4JYV4"
    )

    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )

    changelog_from_git_commits
  end

  desc "Submit a new production build to App Store"
  lane :production_release do
    increment_version_number(
      xcodeproj: "ios/smbmobile.xcodeproj",
      bump_type: "patch"
    )
    increment_build_number(
      xcodeproj: "ios/smbmobile.xcodeproj"
    )

    build_ios_app(
      workspace: "ios/smbmobile.xcworkspace",
      scheme: "smbmobile",
      export_method: "app-store",
      export_options: {
        method: "app-store",
        provisioningProfiles: {
          "com.insighture.smbmobile" => "match AppStore com.insighture.smbmobile"
        }
      },
      output_directory: "ios/build",
      output_name: "smbmobile.ipa",
      team_id: ENV['APPLE_TEAM_ID'] || "96W7U4JYV4"
    )

    upload_to_app_store(
      skip_metadata: true,
      skip_screenshots: true,
      precheck_include_in_app_purchases: false
    )

    changelog_from_git_commits
  end

  desc "Submit a new production build to App Store (legacy)"
  lane :release do
    increment_version_number(
      xcodeproj: "ios/smbmobile.xcodeproj",
      bump_type: "patch"
    )
    increment_build_number(
      xcodeproj: "ios/smbmobile.xcodeproj"
    )

    build_ios_app(
      workspace: "ios/smbmobile.xcworkspace",
      scheme: "smbmobile",
      export_method: "app-store",
      export_options: {
        method: "app-store",
        provisioningProfiles: {
          "com.insighture.smbmobile" => "match AppStore com.insighture.smbmobile"
        }
      },
      output_directory: "ios/build",
      output_name: "smbmobile.ipa",
      team_id: ENV['APPLE_TEAM_ID'] || "96W7U4JYV4"
    )

    upload_to_app_store(
      skip_metadata: true,
      skip_screenshots: true,
      precheck_include_in_app_purchases: false
    )

    changelog_from_git_commits
  end
end
